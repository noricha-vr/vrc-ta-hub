{% extends 'ta_hub/base.html' %}

{% block title %}集会設定 - {{ community.name }}{% endblock %}

{% block main %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'event:my_list' %}">イベント管理</a></li>
            <li class="breadcrumb-item active">集会設定</li>
        </ol>
    </nav>

    <h1 class="h3 mb-4">集会設定: {{ community.name }}</h1>

    {% include 'ta_hub/messages.html' %}

    <!-- 基本情報セクション -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fa-solid fa-info-circle me-2"></i>基本情報
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="text-muted">集会名</label>
                    <p class="mb-0">{{ community.name }}</p>
                </div>
                <div class="col-md-4">
                    <label class="text-muted">開催曜日</label>
                    <p class="mb-0">
                        {% for weekday in community.weekdays %}
                            {% if weekday == 'Sun' %}日曜日{% endif %}
                            {% if weekday == 'Mon' %}月曜日{% endif %}
                            {% if weekday == 'Tue' %}火曜日{% endif %}
                            {% if weekday == 'Wed' %}水曜日{% endif %}
                            {% if weekday == 'Thu' %}木曜日{% endif %}
                            {% if weekday == 'Fri' %}金曜日{% endif %}
                            {% if weekday == 'Sat' %}土曜日{% endif %}
                            {% if weekday == 'Other' %}その他{% endif %}
                            {% if not forloop.last %}、{% endif %}
                        {% empty %}
                            -
                        {% endfor %}
                    </p>
                </div>
                <div class="col-md-4">
                    <label class="text-muted">開始時刻</label>
                    <p class="mb-0">{{ community.start_time|time:"H:i" }}</p>
                </div>
            </div>
            <a href="{% url 'community:update' %}" class="btn btn-primary">
                <i class="fa-solid fa-edit me-1"></i>集会情報を編集
            </a>
        </div>
    </div>

    <!-- 外部連携セクション -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fa-solid fa-link me-2"></i>外部連携
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h6 class="mb-2">VRCイベントカレンダー連携</h6>
                    <p class="text-muted small mb-2">VRCイベントカレンダー用の情報を設定します。</p>
                    <a href="{% url 'community:calendar_update' %}" class="btn btn-outline-primary">
                        <i class="fa-solid fa-calendar me-1"></i>カレンダー設定
                    </a>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <h6 class="mb-2">Twitter投稿テンプレート</h6>
                    <p class="text-muted small mb-2">イベント告知用のテンプレートを管理します。</p>
                    <a href="{% url 'twitter:template_list' %}" class="btn btn-outline-primary">
                        <i class="fa-brands fa-twitter me-1"></i>テンプレート管理
                    </a>
                </div>
                <div class="col-md-4">
                    <h6 class="mb-2">API管理</h6>
                    <p class="text-muted small mb-2">外部連携用のAPIキーを管理します。</p>
                    <a href="{% url 'account:api_key_list' %}" class="btn btn-outline-primary">
                        <i class="fa-solid fa-key me-1"></i>API管理
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- メンバー管理セクション（主催者のみ） -->
    {% if is_owner %}
    <div class="card mb-4">
        <div class="card-header">
            <i class="fa-solid fa-users me-2"></i>メンバー管理
        </div>
        <div class="card-body">
            <p class="text-muted small mb-2">スタッフの追加・削除や招待リンクの管理を行います。</p>
            <a href="{% url 'community:member_manage' community.pk %}" class="btn btn-outline-primary">
                <i class="fa-solid fa-user-cog me-1"></i>メンバーを管理
            </a>
        </div>
    </div>
    {% endif %}

    {% if is_owner %}
    {# 危険な操作セクション（主催者のみ） #}
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger bg-opacity-10 text-danger">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>危険な操作
        </div>
        <div class="card-body">
            {% if community.end_at %}
            <div class="alert alert-warning mb-3">
                <i class="fa-solid fa-info-circle me-2"></i>
                この集会は {{ community.end_at|date:"Y年n月j日" }} に閉鎖されています。
            </div>
            <h6 class="mb-2">集会の再開</h6>
            <p class="text-muted small mb-2">閉鎖した集会を再開します。定期イベントは別途設定し直す必要があります。</p>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#reopenCommunityModal">
                <i class="fa-solid fa-play me-1"></i>集会を再開する
            </button>
            {% else %}
            <h6 class="mb-2">集会の閉鎖</h6>
            <p class="text-muted small mb-2">集会を閉鎖すると、閉鎖日以降のイベントは削除されます。</p>
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#closeCommunityModal">
                <i class="fa-solid fa-stop me-1"></i>集会を閉鎖する
            </button>
            {% endif %}

            <hr class="my-4">

            {# 主催者引き継ぎセクション #}
            <h6 class="mb-2">主催者の引き継ぎ</h6>
            <p class="text-muted small mb-2">主催者権限を他のユーザーに引き継ぎます。</p>

            {% if ownership_transfer_invitation %}
            <div class="alert alert-warning mb-3">
                <i class="fa-solid fa-link me-2"></i>
                <strong>有効な引き継ぎリンクがあります</strong><br>
                <small class="text-muted">有効期限: {{ ownership_transfer_invitation.expires_at|date:"Y/m/d H:i" }}</small>
            </div>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="transferLinkInput"
                       value="{{ request.scheme }}://{{ request.get_host }}{% url 'community:accept_ownership_transfer' ownership_transfer_invitation.token %}"
                       readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyTransferLink()">
                    <i class="fa-solid fa-copy me-1"></i>コピー
                </button>
            </div>
            <form action="{% url 'community:revoke_ownership_transfer' community.pk ownership_transfer_invitation.pk %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="fa-solid fa-trash me-1"></i>リンクを削除
                </button>
            </form>
            {% else %}
            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#createTransferModal">
                <i class="fa-solid fa-right-left me-1"></i>引き継ぎリンクを作成
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'event:my_list' %}" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i>イベント管理に戻る
        </a>
    </div>
</div>

{% if is_owner %}
<!-- 閉鎖確認モーダル -->
<div class="modal fade" id="closeCommunityModal" tabindex="-1" aria-labelledby="closeCommunityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="closeCommunityModalLabel">集会の閉鎖確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>この集会を閉鎖しますか？</p>
                <p class="text-danger">閉鎖日以降のイベントは削除されます。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <form action="{% url 'community:close' community.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">閉鎖する</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 再開確認モーダル -->
<div class="modal fade" id="reopenCommunityModal" tabindex="-1" aria-labelledby="reopenCommunityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reopenCommunityModalLabel">集会の再開確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>この集会を再開しますか？</p>
                <p class="text-info">定期イベントを再開するには、設定から改めてイベントを登録し直してください。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <form action="{% url 'community:reopen' community.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">再開する</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 引き継ぎリンク作成モーダル -->
<div class="modal fade" id="createTransferModal" tabindex="-1" aria-labelledby="createTransferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h5 class="modal-title" id="createTransferModalLabel">
                    <i class="fa-solid fa-exclamation-triangle text-warning me-2"></i>主催者引き継ぎの確認
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>注意: この操作は取り消せません</strong>
                </div>
                <p>引き継ぎリンクを作成すると、リンクを受け取った人が主催者になります。</p>
                <ul class="text-muted">
                    <li>あなたはスタッフに降格されます</li>
                    <li>主催者権限（メンバー管理、集会閉鎖など）を失います</li>
                    <li>リンクは7日間有効です</li>
                </ul>
                <p class="mb-0"><strong>本当に引き継ぎリンクを作成しますか？</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <form action="{% url 'community:create_ownership_transfer' community.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">引き継ぎリンクを作成</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function copyTransferLink() {
    const input = document.getElementById('transferLinkInput');
    input.select();
    input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value).then(function() {
        alert('リンクをコピーしました');
    }).catch(function() {
        alert('コピーに失敗しました。手動でコピーしてください。');
    });
}
</script>
{% endif %}

{% endblock %}
