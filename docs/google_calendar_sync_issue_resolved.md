# Googleカレンダー同期の重複問題 - 原因と解決策

## 問題の概要

Googleカレンダーへのイベント同期で、以下の問題が発生していました：

1. **重複登録**: 同じイベントが複数回Googleカレンダーに登録される
2. **件数の不一致**: データベースとGoogleカレンダーのイベント数が一致しない

## 原因

### 1. 手動で作成された重複イベント
- **株式投資座談会**: DBには1件しかないのに、Googleカレンダーには5件存在
- 過去に手動または別の同期処理で作成されたイベントが残存していた

### 2. マスターイベントのカウント問題
- **定期イベントのマスター**（`is_recurring_master=True`）は同期対象外
- しかし、DBのイベント数にはマスターイベントも含まれるため、件数が一致しない
- 例: VR酔い訓練集会では、マスターイベント1件 + インスタンス4件 = DB5件、Google4件

### 3. 同期処理の不整合
- DBにGoogle Calendar IDが保存されているが、実際にはGoogleカレンダーに存在しないイベントがある
- 逆に、GoogleカレンダーにあるがDBに記録されていないイベントも存在

## 解決策

### 1. 重複イベントの削除スクリプト作成
`app/scripts/fix_calendar_sync.py`を作成し、以下の処理を実装：

```python
# 主な処理フロー
1. Googleカレンダーの全イベントを取得
2. DBの期間内イベント（マスター除く）を取得
3. 日時でマッチングし、不整合を検出
4. GoogleカレンダーにあってDBにないイベントを削除
5. DBにあってGoogleカレンダーにないイベントを作成
```

### 2. 実行結果
```
削除: 6件（重複していたイベント）
作成: 1件（同期されていなかったイベント）
更新: 0件
エラー: 0件
```

### 3. マスターイベントの扱い
- **現在の仕様**: マスターイベントは同期対象外
- **理由**: マスターイベントは定期ルールの基準となる仮想的なイベントであり、実際の開催イベントではない
- **推奨**: DBクエリ時に`is_recurring_master=False`でフィルタリングして件数を比較

## 今後の改善提案

### 1. 同期処理の改善
- `sync_to_google.py`の`_get_google_events`メソッドで、より厳密なマッチングを実装
- イベントIDベースの管理から、日時ベースの管理への移行を検討

### 2. 監視機能の追加
- 定期的に重複チェックを実行するスクリプトを作成
- 不整合が検出された場合にアラートを送信

### 3. データベースの整合性チェック
- Google Calendar IDの妥当性を定期的に検証
- 存在しないIDを持つレコードをクリーンアップ

## スクリプト一覧

1. **check_calendar_duplicates.py**: 重複と不整合をチェック
2. **check_specific_community.py**: 特定コミュニティの詳細確認
3. **analyze_sync_issue.py**: 同期問題の詳細分析
4. **fix_calendar_sync.py**: 重複を修正（--applyオプションで実行）
5. **check_remaining_issues.py**: 残りの問題を確認

## 結論

重複問題は解決されました。残る「件数の不一致」は、マスターイベントのカウント方法によるもので、これは仕様通りの動作です。

今後は`fix_calendar_sync.py`を定期的に実行することで、同期の整合性を保つことができます。