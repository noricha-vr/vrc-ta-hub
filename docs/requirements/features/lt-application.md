# LT申請機能 仕様書

## 概要

コミュニティページからログインユーザーがLT（発表）の申請を行える機能。
申請は管理者の承認後、通常のイベント詳細として表示される。

## ユーザー価値

- **発表希望者**: コミュニティページから直接LT申請ができる
- **主催者**: 申請を一元管理し、承認/却下の判断ができる
- **参加者**: 承認された発表が開催日程に表示される

---

## 機能要件

### 1. LT申請フォーム

#### 表示条件

- コミュニティページの「開催日程」セクションに「LTを申し込む」ボタンを配置
- ボタンはログイン済みユーザーのみクリック可能
- 未ログインの場合はログインページへリダイレクト

#### 入力項目

| 項目 | 必須 | 説明 |
|------|------|------|
| 開催日 | 必須 | ドロップダウンで選択（受付中のイベントのみ表示） |
| 発表開始時刻 | 必須 | イベント開催時間内で選択 |
| 発表時間（分） | 必須 | デフォルト: 30分 |
| テーマ（タイトル） | 必須 | 発表タイトル |
| 発表者名 | 必須 | ログインユーザー名を自動適用（編集不可、ユーザー名変更リンクを配置） |

#### 時刻選択の制約

- 選択可能な時刻: イベントの `start_time` 〜 `end_time` の範囲内
- 時刻の刻み: 5分単位を推奨

---

### 2. LT受付のオン/オフ

#### Event（周回）ごとの設定

| 状況 | デフォルト値 |
|------|-------------|
| 既存の周回（マイグレーション時） | オフ（False） |
| 新規作成時 | オン（True） |

#### 設定変更

- 周回の作成画面/編集画面でオン/オフを切り替え可能
- 管理者（owner/staff）のみ変更可能

---

### 3. 承認フロー

#### 承認権限

- 集会の管理者（owner / staff）のみ

#### 承認/却下時の動作

| アクション | 動作 |
|-----------|------|
| 承認 | `status` を `approved` に変更。通常のイベント詳細として表示される |
| 却下 | `status` を `rejected` に変更。理由を任意入力可能 |

#### 主催者の編集権限

承認後も主催者は以下を編集可能:
- 発表開始時刻
- 発表時間（分）

---

### 4. 通知システム

#### 申請時の通知（主催者向け）

**通知先:**
- Owner権限を持つユーザーのメールアドレス
- 設定されていればDiscord Webhook URL
- 両方設定されていれば両方に送信

**通知内容:**
- 申請者名
- 申請されたイベント日時
- テーマ（タイトル）
- 承認/却下画面へのリンク

#### 承認/却下時の通知（申請者向け）

**通知先:**
- 申請者のメールアドレス
- 設定されていればDiscord Webhook URL

**通知内容:**
- 結果（承認/却下）
- 却下の場合は理由（入力されていれば）
- イベント詳細ページへのリンク（承認時）

---

## データモデル変更

### Event モデル（変更）

```python
class Event(models.Model):
    # 既存フィールド...

    # 追加
    accepts_lt_application = models.BooleanField(
        'LT申し込み受付',
        default=True,
        help_text='オンの場合、ユーザーからのLT申請を受け付ける'
    )
```

**マイグレーション:**
- 既存データ: `accepts_lt_application = False`

---

### EventDetail モデル（変更）

```python
class EventDetail(models.Model):
    STATUS_CHOICES = [
        ('pending', '承認待ち'),
        ('approved', '承認済み'),
        ('rejected', '却下'),
    ]

    # 既存フィールド...

    # 追加
    status = models.CharField(
        '申請状態',
        max_length=10,
        choices=STATUS_CHOICES,
        default='approved',
        db_index=True
    )
    applicant = models.ForeignKey(
        'user_account.CustomUser',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='lt_applications',
        verbose_name='申請者'
    )
    rejection_reason = models.TextField(
        '却下理由',
        blank=True,
        default=''
    )
```

**マイグレーション:**
- 既存データ: `status = 'approved'`, `applicant = NULL`

---

### Community モデル（変更）

```python
class Community(models.Model):
    # 既存フィールド...

    # 追加
    notification_webhook_url = models.URLField(
        'Discord Webhook URL',
        blank=True,
        help_text='LT申請通知を送信するDiscord Webhook URL'
    )
```

---

## 画面一覧

| 画面 | URL例 | 説明 |
|------|-------|------|
| LT申請フォーム | `/event/apply/<community_id>/` | 申請入力画面 |
| 申請一覧（主催者用） | `/community/<id>/applications/` | 承認待ち申請の一覧 |
| 承認/却下画面 | `/event/application/<id>/review/` | 個別申請の承認/却下 |

---

## 受け入れ確認の手順

### 申請者視点

- [ ] コミュニティページで「LTを申し込む」ボタンをクリックし、申請フォームが表示されることを確認
- [ ] 未ログイン時にボタンをクリックすると、ログインページにリダイレクトされることを確認
- [ ] 開催日ドロップダウンに受付中のイベントのみ表示されることを確認
- [ ] 発表開始時刻がイベント開催時間内でのみ選択できることを確認
- [ ] 申請送信後、確認メッセージが表示されることを確認
- [ ] 承認/却下時にメール通知を受信することを確認

### 主催者視点

- [ ] 申請があった際にメール通知を受信することを確認
- [ ] Discord Webhook URL設定時、Discordにも通知が届くことを確認
- [ ] 承認/却下画面で申請内容を確認し、承認/却下できることを確認
- [ ] 却下時に理由を入力できることを確認
- [ ] 承認後、開催日程に発表が表示されることを確認
- [ ] 承認後も発表時刻・発表時間を編集できることを確認

### 管理設定視点

- [ ] 周回作成時にLT受付がデフォルトでオンになっていることを確認
- [ ] 周回編集画面でLT受付のオン/オフを切り替えられることを確認
- [ ] LT受付がオフの周回は申請フォームの選択肢に表示されないことを確認

---

## 技術的完了条件

- [ ] マイグレーションファイルが作成され、適用できる
- [ ] 既存のEventDetailが `status='approved'` で保持される
- [ ] 既存のEventが `accepts_lt_application=False` で保持される
- [ ] 新規テストが追加され、パスする
- [ ] 型エラーがない
